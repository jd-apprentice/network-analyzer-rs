<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Red</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #5a67d8 0%, #6c4299 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #5a67d8 0%, #6c4299 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px 20px;
            background: #e7f5ff;
            border-radius: 20px;
            color: #1971c2;
            font-weight: 600;
        }

        .status.scanning {
            background: #fff9db;
            color: #854d0e;
        }

        .status.complete {
            background: #d3f9d8;
            color: #1c7430;
        }

        .status.error {
            background: #ffe0e0;
            color: #a50e0e;
        }

        #network-graph {
            width: 100%;
            height: 700px;
            background: #f8f9fa;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: white;
        }

        .stat-card {
            background: linear-gradient(135deg, #5a67d8 0%, #6c4299 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .device-list {
            padding: 30px;
        }

        .device-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .device-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .node {
            cursor: pointer;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .node text {
            font-size: 12px;
            pointer-events: none;
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üåê Analizador de Red Local</h1>
            <p>Descubre y visualiza todos los dispositivos en tu red</p>
        </div>

        <div class="controls">
            <button id="scanBtn" onclick="startScan()">üîç Escanear Red</button>
            <div id="status" class="status">Listo para escanear</div>
        </div>

        <div id="stats" class="stats" style="display:none;"></div>

        <svg id="network-graph"></svg>

        <div id="device-list" class="device-list"></div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        let topology = null;

        async function startScan() {
            const btn = document.getElementById('scanBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            status.textContent = '‚è≥ Escaneando red... Esto puede tardar 1-2 minutos';
            status.className = 'status scanning';

            try {
                const response = await fetch('http://localhost:8080/api/scan');
                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Unknown error occurred');
                }

                topology = data;

                status.textContent = `‚úÖ Escaneo completo - ${topology.total_devices} dispositivos encontrados`;
                status.className = 'status complete';

                displayStats(topology);
                visualizeNetwork(topology);
                displayDeviceList(topology);
            } catch (error) {
                status.textContent = `‚ùå Error: ${error.message}`;
                status.className = 'status error';
                console.error('Scan failed:', error);
            } finally {
                btn.disabled = false;
            }
        }

        function displayStats(data) {
            const statsDiv = document.getElementById('stats');
            statsDiv.style.display = 'grid';

            const webServers = data.devices.filter(d => d.device_type.includes('Web')).length;
            const sshServers = data.devices.filter(d => d.device_type.includes('SSH')).length;

            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Dispositivos</div>
                    <div class="stat-value">${data.total_devices}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gateway</div>
                    <div class="stat-value" style="font-size:1.5em">${data.gateway}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Subred</div>
                    <div class="stat-value" style="font-size:1.5em">${data.subnet}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Servidores Web</div>
                    <div class="stat-value">${webServers}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Servidores SSH</div>
                    <div class="stat-value">${sshServers}</div>
                </div>
            `;
        }

        function visualizeNetwork(data) {
            const tooltip = d3.select("#tooltip");
            const svg = d3.select("#network-graph");
            svg.selectAll("*").remove();

            const width = svg.node().getBoundingClientRect().width;
            const height = 700;

            const nodes = [
                { id: data.gateway, type: 'gateway', label: 'üåê Gateway', ...data },
                ...data.devices.map(d => ({
                    id: d.ip,
                    type: 'device',
                    label: d.hostname || d.ip,
                    ...d
                }))
            ];

            const links = data.devices.map(d => ({
                source: data.gateway,
                target: d.ip
            }));

            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(150))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(50));

            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("class", "link")
                .attr("stroke-width", 2);

            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", d => d.type === 'gateway' ? 30 : 20)
                .attr("fill", d => {
                    if (d.type === 'gateway') return '#667eea';
                    if (d.device_type.includes('Web')) return '#ff6b6b';
                    if (d.device_type.includes('SSH')) return '#51cf66';
                    if (d.device_type.includes('Database')) return '#ffd43b';
                    return '#868e96';
                })
                .attr("stroke", "#fff")
                .attr("stroke-width", 3)
                .on("mouseover", function (event, d) {
                    tooltip.style("opacity", 1)
                        .html(`
                            <strong>${d.label}</strong><br>
                            IP: ${d.ip}<br>
                            Tipo: ${d.device_type || 'Gateway'}<br>
                            ${d.ports ? `Puertos: ${d.ports.join(', ')}` : ''}
                        `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function () {
                    tooltip.style("opacity", 0);
                });

            node.append("text")
                .attr("dy", 35)
                .attr("text-anchor", "middle")
                .text(d => d.type === 'gateway' ? 'üåê Gateway' : (d.hostname || d.ip.split('.').pop()));

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

        }

        let simulation;

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function displayDeviceList(data) {
            const listDiv = document.getElementById('device-list');
            listDiv.innerHTML = '<h2 style="margin-bottom:20px">üìã Dispositivos Detectados</h2>';

            for (const device of data.devices) {
                const item = document.createElement('div');
                item.className = 'device-item';
                item.innerHTML = `
                    <strong>${device.hostname || device.ip}</strong>
                    <div style="color:#666; font-size:0.9em; margin-top:5px">
                        IP: ${device.ip} | Tipo: ${device.device_type} |
                        Puertos abiertos: ${device.ports.length > 0 ? device.ports.join(', ') : 'Ninguno'}
                    </div>
                `;
                listDiv.appendChild(item);
            }
        }
    </script>
</body>

</html>